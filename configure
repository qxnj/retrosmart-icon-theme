#!/bin/sh

if [ -f makefile ]; then
	echo "Configuration done. Run 'make'."
	exit 0
fi

name="retrosmart-icon-theme"
out="$name/scalable"

# Get all links
for i in src/*.links; do
	# FIXME: The .links file always have the respective image file in the fist
	#        line?
	source="$(head -n1 "$i")"

	if [ -f "src/$source" ]; then
		links="$links $i"
	else
		echo "File '$source' referenced in '$i' not found."
		exit 1
	fi
done

# Generate preview file list
while read -r path; do
	source="src/$path"
	if [ -f "$source" ]; then
		preview="$preview $source"
	else
		echo "File '$source' referenced in '$1' not found."
	fi
done < src/preview.list

# Generate makefile
{
	printf "include makefile.in\n\n"

	printf "$name:\n"
	printf "\tmkdir -p $out\n"

	printf "$name/index.theme: $name\n"
	printf "\tcp src/index.theme $name/\n"

	for i in $links; do
		source="$(head -n1 "$i")"

		while read -r link_file; do
			# Empty line
			if [ -z "$link_file" ]; then 
				continue
			fi

			icons="$icons $out/$link_file"
			printf "$out/$link_file: $name/index.theme\n"

			if [ "$source" = "$link_file" ]; then
				printf "\tcp src/$source $out/$link_file\n"
			else
				printf "\tcd $out && ln -s $source $link_file\n"
			fi
		done < "$i"
	done

	printf "\nicons: $icons\n\n"

	printf "preview.png: $preview\n"
	printf "\tmontage -verbose -resize 64 -geometry +16+16 -tile 9x6 $preview preview.png\n"
} > makefile

echo "Configuration done. Run 'make'."
