#!/bin/sh

if [ -f makefile ]; then
	echo "Configuration done. Run 'make'."
	exit 0
fi

name="retrosmart-icon-theme"
svg_out="$name/scalable"
png_out="$name/fixed"

make_recipe() {
	case "${2##*.}" in
		png)
			icons="$icons $png_out/$2"
			printf "$png_out/$2: $name/index.theme\n"
			if [ -z "$curr_png" ]; then
				printf "\tmagick -background none src/$1 -resize 48x48 $png_out/${1%.*}.png\n"
				curr_png=$1
			fi
			printf "\tcd $png_out && ln -s ${1%.*}.png $2\n"
			;;
		svg)
			icons="$icons $svg_out/$2"
			printf "$svg_out/$2: $name/index.theme\n"
			if [ "$1" = "$2" ]; then
				printf "\tcp src/$1 $svg_out/$2\n"
			else
				printf "\tcd $svg_out && ln -s $1 $2\n"
			fi
			;;
	esac
}

# Check dependencies
for cmd in make magick; do
	if ! command -v "$cmd" > /dev/null; then
		echo "$cmd not found."
		exit 2
	fi
done

# Get all links
for i in src/*.links; do
	# FIXME: The .links file always have the respective image file in the first
	#        line?
	source="$(head -n1 "$i")"

	if [ -f "src/$source" ]; then
		links="$links $i"
	else
		echo "File '$source' referenced in '$i' not found."
		exit 1
	fi
done

# Generate preview file list
while read -r path; do
	source="src/$path"
	if [ -f "$source" ]; then
		preview="$preview $source"
	else
		echo "File '$source' referenced in '$1' not found."
	fi
done < src/preview.list

# Generate makefile
{
	printf "include makefile.in\n\n"

	printf "$name:\n"
	printf "\tmkdir -p $svg_out\n"
	printf "\tmkdir -p $png_out\n"

	printf "$name/index.theme: $name\n"
	printf "\tcp src/index.theme $name/\n"

	for i in $links; do
		source="$(head -n1 "$i")"
		curr_png=""

		while read -r link_file; do
			# Empty line
			if [ -z "$link_file" ]; then 
				continue
			fi

			make_recipe "$source" "$link_file"

		done < "$i"
	done

	printf "\nicons: $icons\n\n"

	printf "preview.png: $preview\n"
	printf "\tmontage -verbose -resize 64 -geometry +16+16 -tile 9x6 $preview preview.png\n"
} > makefile

echo "Configuration done. Run 'make'."
